---
title: "result"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      message = FALSE,
                      warning = FALSE)
```

## This document shows the result of the code

## CardioStatsUSA
To install CardioStatsUSA, run this
```{r,eval=FALSE}
install.packages("CardioStatsUSA")
```
if not work, try this
```{r,eval=FALSE}
if (!requireNamespace("remotes", quietly = TRUE))
install.packages("remotes")
remotes::install_github("jhs-hwg/CardioStatsUSA")
```

## R packages
```{r,warning=FALSE,message=FALSE}
library(cardioStatsUSA)
library(tidyverse)
library(survey)
library(gtsummary)
library(mice)
```


## data
```{r,warning=FALSE,message=FALSE}
# head(nhanes_data)
dat<-nhanes_data
```


## data cleaning

**combine categories**
```{r}
dat <- dat %>%
  mutate(
    # Demographics variables
    # demo_age_cat
    demo_age_cat = factor(case_when(
      demo_age_cat == "65 to 74" ~ "65+",  
      demo_age_cat == "75+" ~ "65+", 
      TRUE ~ demo_age_cat
    )),
    # demo_race
    demo_race=factor(case_when(
      demo_race == "Non-Hispanic Asian" ~ "Hispanic/Asian/Other",
      demo_race == "Hispanic" ~ "Hispanic/Asian/Other",
      demo_race == "Other" ~ "Hispanic/Asian/Other",
      TRUE ~ demo_race
    )),
    
    # Antihypertensive medication variables
    # bp_med_n_class
    bp_med_n_class=factor(case_when(
      bp_med_n_class == "Two" ~ "Two or more",
      bp_med_n_class == "Three" ~ "Two or more",
      bp_med_n_class == "Four or more" ~ "Two or more",
      TRUE ~ bp_med_n_class
    )),
    # bp_med_n_pills
    bp_med_n_pills=factor(case_when(
      bp_med_n_pills == "Two" ~ "Two or more",
      bp_med_n_pills == "Three" ~ "Two or more",
      bp_med_n_pills == "Four or more" ~ "Two or more",
      TRUE ~ bp_med_n_pills
    ))
  )

```

### recode categorical data
```{r}
dat <- dat %>% mutate(
  # Demographics variables
  demo_age_cat=relevel(demo_age_cat, ref = "18 to 44"),
  demo_race=relevel(demo_race,ref="Non-Hispanic White"),
  pregnant=ifelse(demo_pregnant=="Yes",1,ifelse(demo_pregnant=="No",0,NA)),
  female=ifelse(demo_gender=="Women",1,ifelse(demo_gender=="Men",0,NA)),
  
  # Blood pressure variables
  bp_uncontrolled_140_90=ifelse(bp_uncontrolled_140_90=="Yes",1,ifelse(bp_uncontrolled_140_90=="No",0,NA)),
  bp_uncontrolled_130_80=ifelse(bp_uncontrolled_130_80=="Yes",1,ifelse(bp_uncontrolled_130_80=="No",0,NA)),
  
  # Hypertension variables
  htn_accaha=ifelse(htn_accaha=="Yes",1,ifelse(htn_accaha=="No",0,NA)),
  htn_aware=ifelse(htn_aware=="Yes",1,ifelse(htn_aware=="No",0,NA)),
  htn_resistant_jnc7=ifelse(htn_resistant_jnc7=="Yes",1,ifelse(htn_resistant_jnc7=="No",0,NA)),
  htn_resistant_accaha=ifelse(htn_resistant_accaha=="Yes",1,ifelse(htn_resistant_accaha=="No",0,NA)),
  htn_resistant_accaha_thz=ifelse(htn_resistant_accaha_thz=="Yes",1,ifelse(htn_resistant_accaha_thz=="No",0,NA)),
  htn_resistant_jnc7_thz=ifelse(htn_resistant_jnc7_thz=="Yes",1,ifelse(htn_resistant_jnc7_thz=="No",0,NA)),
  
  # Antihypertensive medication variables
  bp_med_use=ifelse(bp_med_use=="Yes",1,ifelse(bp_med_use=="No",0,NA)),
  bp_med_recommended_jnc7=ifelse(bp_med_recommended_jnc7=="Yes",1,ifelse(bp_med_recommended_jnc7=="No",0,NA)),
  bp_med_recommended_accaha=ifelse(bp_med_recommended_accaha=="Yes",1,ifelse(bp_med_recommended_accaha=="No",0,NA)),
  bp_med_recommended_escesh=ifelse(bp_med_recommended_escesh=="Yes",1,ifelse(bp_med_recommended_escesh=="No",0,NA)),
  bp_med_n_class=relevel(bp_med_n_class,ref="None"),
  bp_med_n_pills=relevel(bp_med_n_pills,ref="None"),
  bp_med_combination=ifelse(bp_med_combination=="Yes",1,ifelse(bp_med_combination=="No",0,NA)),
  bp_med_pills_gteq_2=ifelse(bp_med_pills_gteq_2=="Yes",1,ifelse(bp_med_pills_gteq_2=="No",0,NA)),
  bp_med_ace=ifelse(bp_med_ace=="Yes",1,ifelse(bp_med_ace=="No",0,NA)),
  bp_med_aldo=ifelse(bp_med_aldo=="Yes",1,ifelse(bp_med_aldo=="No",0,NA)),
  bp_med_alpha=ifelse(bp_med_alpha=="Yes",1,ifelse(bp_med_alpha=="No",0,NA)),
  bp_med_angioten=ifelse(bp_med_angioten=="Yes",1,ifelse(bp_med_angioten=="No",1,NA)),
  bp_med_beta=ifelse(bp_med_beta=="Yes",1,ifelse(bp_med_beta=="No",0,NA)),
  bp_med_ccb=ifelse(bp_med_ccb=="Yes",1,ifelse(bp_med_ccb=="No",0,NA)),
  bp_med_ccb_dh=ifelse(bp_med_ccb_dh=="Yes",1,ifelse(bp_med_ccb_dh=="No",0,NA)),
  bp_med_ccb_ndh=ifelse(bp_med_ccb_ndh=="Yes",1,ifelse(bp_med_ccb_ndh=="No",0,NA)),
  bp_med_central=ifelse(bp_med_central=="Yes",1,ifelse(bp_med_central=="No",0,NA)),
  bp_med_renin_inhibitors=ifelse(bp_med_renin_inhibitors=="Yes",1,ifelse(bp_med_renin_inhibitors=="No",0,NA)),
  bp_med_vasod=ifelse(bp_med_vasod=="Yes",1,ifelse(bp_med_vasod=="No",0,NA)),
  bp_med_diur_loop=ifelse(bp_med_diur_loop=="Yes",1,ifelse(bp_med_diur_loop=="No",0,NA)),
  bp_med_diur_Ksparing=ifelse(bp_med_diur_Ksparing=="Yes",1,ifelse(bp_med_diur_Ksparing=="No",0,NA)),
  bp_med_diur_thz=ifelse(bp_med_diur_thz=="Yes",1,ifelse(bp_med_diur_thz=="No",0,NA)),
  
  # Comorbidities variables
  cc_smoke=relevel(cc_smoke,ref="Never"),
  cc_bmi=relevel(cc_bmi,ref="<25"),
  cc_diabetes=ifelse(cc_diabetes=="Yes",1,ifelse(cc_diabetes=="No",0,NA)),
  cc_ckd=ifelse(cc_ckd=="Yes",1,ifelse(cc_ckd=="No",0,NA)),
  cc_cvd_mi=ifelse(cc_cvd_mi=="Yes",1,ifelse(cc_cvd_mi=="No",0,NA)),
  cc_cvd_chd=ifelse(cc_cvd_chd=="Yes",1,ifelse(cc_cvd_chd=="No",0,NA)),
  cc_cvd_stroke=ifelse(cc_cvd_stroke=="Yes",1,ifelse(cc_cvd_stroke=="No",0,NA)),
  cc_cvd_ascvd=ifelse(cc_cvd_ascvd=="Yes",1,ifelse(cc_cvd_ascvd=="No",0,NA)),
  cc_cvd_hf=ifelse(cc_cvd_hf=="Yes",1,ifelse(cc_cvd_hf=="No",0,NA)),
  cc_cvd_any=ifelse(cc_cvd_any=="Yes",1,ifelse(cc_cvd_any=="No",0,NA))
)
```

**Transform categorical data into factor type**
```{r}
dat = dat %>% 
  mutate(
    # Demographics variables
    pregnant = as.factor(pregnant),
    female = as.factor(female),
    
    # Blood pressure variables
    bp_uncontrolled_140_90 = as.factor(bp_uncontrolled_140_90),
    bp_uncontrolled_130_80 = as.factor(bp_uncontrolled_130_80),
    
    # Hypertension variables
    htn_accaha = as.factor(htn_accaha),
    htn_aware = as.factor(htn_aware),
    htn_resistant_jnc7 = as.factor(htn_resistant_jnc7),
    htn_resistant_accaha = as.factor(htn_resistant_accaha),
    htn_resistant_accaha_thz = as.factor(htn_resistant_accaha_thz),
    htn_resistant_jnc7_thz = as.factor(htn_resistant_jnc7_thz),
    
    # Antihypertensive medication variables
    bp_med_use = as.factor(bp_med_use),
    bp_med_recommended_jnc7 = as.factor(bp_med_recommended_jnc7),
    bp_med_recommended_accaha = as.factor(bp_med_recommended_accaha),
    bp_med_recommended_escesh = as.factor(bp_med_recommended_escesh),
    bp_med_combination = as.factor(bp_med_combination),
    bp_med_pills_gteq_2 = as.factor(bp_med_pills_gteq_2),
    bp_med_ace = as.factor(bp_med_ace),
    bp_med_aldo = as.factor(bp_med_aldo),
    bp_med_alpha = as.factor(bp_med_alpha),
    bp_med_angioten = as.factor(bp_med_angioten),
    bp_med_beta = as.factor(bp_med_beta),
    bp_med_ccb = as.factor(bp_med_ccb),
    bp_med_ccb_dh = as.factor(bp_med_ccb_dh),
    bp_med_ccb_ndh = as.factor(bp_med_ccb_ndh),
    bp_med_central = as.factor(bp_med_central),
    bp_med_renin_inhibitors = as.factor(bp_med_renin_inhibitors),
    bp_med_vasod = as.factor(bp_med_vasod),
    bp_med_diur_loop = as.factor(bp_med_diur_loop),
    bp_med_diur_Ksparing = as.factor(bp_med_diur_Ksparing),
    bp_med_diur_thz = as.factor(bp_med_diur_thz),
    
    # Comorbidities variables
    cc_diabetes = as.factor(cc_diabetes),
    cc_ckd = as.factor(cc_ckd),
    cc_cvd_mi = as.factor(cc_cvd_mi),
    cc_cvd_chd = as.factor(cc_cvd_chd),
    cc_cvd_stroke = as.factor(cc_cvd_stroke),
    cc_cvd_ascvd = as.factor(cc_cvd_ascvd),
    cc_cvd_hf = as.factor(cc_cvd_hf),
    cc_cvd_any = as.factor(cc_cvd_any)
  )
```

### select the relavent variables
```{r}
dat=dat%>%select(
  # Survey variables
  svy_id, svy_psu,svy_strata, svy_weight_mec, svy_subpop_htn,
  svy_year,
  # Demographics variables
  demo_age_cat, demo_race, pregnant, female, 
  # Blood pressure variables
  bp_uncontrolled_140_90,bp_uncontrolled_130_80,
  # Hypertension variables
  htn_accaha, htn_aware, htn_resistant_accaha,
  htn_resistant_accaha_thz,
  # Antihypertensive medication variables
  bp_med_use, bp_med_recommended_accaha, bp_med_n_class,
  bp_med_n_pills, bp_med_combination, bp_med_pills_gteq_2,
  bp_med_ace, bp_med_aldo, bp_med_alpha, bp_med_angioten,
  bp_med_beta, bp_med_ccb, bp_med_ccb_dh, bp_med_ccb_ndh, 
  bp_med_central, bp_med_renin_inhibitors, bp_med_vasod,
  bp_med_diur_loop, bp_med_diur_Ksparing, bp_med_diur_thz, 
  # Comorbidities variables
  cc_smoke, cc_bmi, cc_diabetes, cc_ckd, cc_cvd_mi, cc_cvd_chd, 
  cc_cvd_stroke, cc_cvd_ascvd, cc_cvd_hf, cc_cvd_any
)
```

**check variables**
```{r}
## Summary Statistics
dat %>% 
  select(demo_age_cat, pregnant, female, bp_med_n_class, htn_accaha, htn_accaha, bp_med_n_pills) %>% 
  tbl_summary() %>% 
  bold_labels()
```



### missing values

Participants with missing pregnancy status were assumed to be nonpregnant for these analyses.
reference: https://www.ahajournals.org/doi/10.1161/HYPERTENSIONAHA.123.20900


survey weights are calibrated within race, gender, and age groups to account for missing information on SBP, DBP or self-reported antihypertensive medication use: 
https://www.sciencedirect.com/science/article/pii/S027263860350004X?casa_token=U-KIitsxOGEAAAAA:jVZ1jyZmsVzR6BGEFVWUTjCh3wfKqvF1JXOLL55qFOu4Dk8giNQSfyU4pGS05Xl4DfM8uiwfPQ


```{r,eval=FALSE}
# adj for pregnant missing
my_dat <- dat %>% 
  mutate(pregnant = ifelse(is.na(pregnant), 0, pregnant))

# Initial imputation
ini = mice(my_dat, maxit = 0, print = FALSE)
pred0 = ini$pred
method0 = ini$method
method0
ini$nmis

# Study missing patterns in more details
md.pattern(my_dat,plot = FALSE)

# Modify the imputation predictor matrix
# and generate 5 imputations with 5 iterations 
# in each imputation using the modified predictor matrix
pred1 = pred0
pred1[, c("svy_id","svy_weight_mec","svy_psu","svy_subpop_htn","svy_subpop_chol")] = 0
pred1

# to Speed Up the Process, subset the data
my_dat<-my_dat%>%filter(svy_subpop_chol == 1)
ini_1 = mice(my_dat, pred = pred1, m = 1, maxit = 1, print = FALSE, seed = 123)

# using quickpred instead
my_dat<-my_dat%>%filter(svy_subpop_htn == 1, svy_year=="1999-2000")
pred2 = quickpred(my_dat, mincor = .1,  exclude = c("svy_id","svy_weight_mec","svy_psu","svy_subpop_htn","svy_subpop_chol"), method = "pearson")
ini_2 = mice(my_dat, pred = pred2, m = 5, maxit = 5, print = FALSE, seed = 123)
```


# survey design
**Notes**: 

* combine weight in many years, refer to https://wwwn.cdc.gov/nchs/nhanes/tutorials/Weighting.aspx 
* The weight in the dataset is: **Full sample 2 year MEC exam weight** (2-year weight?)
* However, for all analyses that combine 1999-2000 with other survey cycles, you must start by using the 4-year weights provided by NCHS for 1999-2002, then include the 2-year weights for each additional 2-year cycle that is combined. (refer to larger nhance dataset to find 4-year weights???)

## weight adjustment for years
To simplify this, we first ignore the "must start by using the 4-year weights provided by NCHS for 1999-2002", and use 2-year weights for all observations from 1999-2016. Treat 2017-2020Mar as 3.2 years.

Combining nine survey cycles + one 3.2 year survey cycle (18+3.2 years: 1999-2016 2017-2020Mar)
```{r}
dat$svy_weight_mec<-ifelse(dat$svy_year %in% c("2017-2020"),dat$svy_weight_mec*3.2/21.2,dat$svy_weight_mec*2/21.2)
```

## define survey design
```{r}
nhanes_all<-svydesign(data=dat,id=~svy_id, strata=~svy_strata, weights=~svy_weight_mec, nest=TRUE)
```

## for blood pressure and hypertension sub-population
According to https://wwwn.cdc.gov/nchs/nhanes/tutorials/VarianceEstimation.aspx, As a general rule when working with complex survey data such as NHANES, you should never drop records from your analysis dataset before executing your analysis procedures. Instead, use the special statements provided in your software's analysis procedure to perform subgroup analyses.

We can use `subset` to produce correct variance estimates.

```{r}
nhanes<-subset(nhanes_all,svy_subpop_htn == 1)
```


